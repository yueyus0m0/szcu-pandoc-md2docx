# 自动化检测规则规范 (Linter Specification)

> **版本**: 1.4
> **适用范围**: `scripts/lint.py` 静态分析逻辑
> **更新日期**: 2025-12-28

本规范定义了 Markdown 论文源文件的自动化检测标准。检测脚本必须依据本规范实现，以确保转换过程的稳定性和生成文档的合规性。

## 1. 严重等级定义 (Severity Definitions)

| 等级符号 | 等级名称 | 含义 | 处理建议 |
|:---:|:---|:---|:---|
| 🛑 | **CRITICAL** | 致命错误，必定导致转换失败或格式崩坏 | 必须修正，否则无法生成 |
| ⚠️ | **WARNING** | 完整性或规范性警告，可能影响最终效果 | 强烈建议修正 |
| ℹ️ | **INFO** | 规范提示，不影响生成但建议优化 | 可选修正 |

---

## 2. 检测规则详细列表

### 2.1 致命错误检查 (Critical Checks)

#### **R1: YAML 头部完整性**
- **等级**: 🛑 CRITICAL
- **规则**: 文件第一行必须是 `---` (YAML 头部起始标记)。
- **验证逻辑**: 读取文件首行并严格匹配。
- **失败后果**: Pandoc 无法解析元数据，转换中断。

#### **R2: CSL 样式文件路径**
- **等级**: 🛑 CRITICAL
- **规则**: `csl:` 字段必须指定 `config/` 目录下的样式文件。
- **验证逻辑**: 解析 YAML 块中的 `csl:` 行，检查值是否包含 `config/` 或 `config\\`。
- **失败后果**: 无法加载引用样式，参考文献格式错误。

#### **R3: 参考文献库文件存在性**
- **等级**: 🛑 CRITICAL
- **规则**: YAML 中的 `bibliography:` 字段指定的 `.bib` 文件必须实际存在。
- **验证逻辑**: 提取文件路径并检查文件系统。
- **失败后果**: Pandoc 报错 `Could not find bibliography file`。

#### **R4: 文献引用 Key 有效性**
- **等级**: 🛑 CRITICAL
- **规则**: 文中引用的文献 Key (如 `[@key]`) 必须在 `.bib` 文件中有对应条目。
- **验证逻辑**: 
    1. 解析 `.bib` 文件提取所有 Key。
    2. 正则匹配文中所有 `[@...]` 引用。
    3. 计算差集并报告未定义的 Key。
- **失败后果**: 引用显示为 `[@unknownKey]` 原文，无法生成参考文献编号。

#### **R5: 代码块嵌套 OpenXML 分节符语法**
- **等级**: 🛑 CRITICAL
- **规则**: 用于分节的 OpenXML 代码块必须包含正确的分节符语法。
- **验证逻辑**: 
    1. 提取所有 ` ```{=openxml} ... ``` ` 代码块。
    2. 检查是否包含 `<w:type w:val='nextPage'/>` 或合法替代值（如 `continuous`, `evenPage`）。
- **失败后果**: Word 文档无法分节，页眉/页码控制失效。

#### **R6: OpenXML 分节符位置合理性**
- **等级**: 🛑 CRITICAL
- **规则**: 分节符应出现在合理位置（通常在封面、摘要、正文等重大段落之间）。
- **验证逻辑**: 若文档有 4+ 个一级标题但未检测到有效分节符，报警。
- **失败后果**: 长文档全部使用同一节格式，页眉/页码无法区分。

#### **R7: 脚注配对完整性**
- **等级**: 🛑 CRITICAL
- **规则**: 脚注引用 `[^id]` 必须在文末有对应定义 `[^id]: 内容`。
- **验证逻辑**: 
    1. 收集所有 `[^id]` (非定义形式)。
    2. 收集所有 `[^id]:` (定义形式)。
    3. 检测是否存在：仅引用、仅定义、ID 不匹配等问题。
- **失败后果**: 脚注编号消失或显示为 `[^id]` 原文。

#### **R8: 资源路径检查**
- **等级**: 🛑 CRITICAL
- **规则**: 图片路径必须有效，且图片名称（alt text）不能为空。
- **验证逻辑**: 
    1. 提取所有 `![alt](path)` 格式的图片。
    2. 检查路径对应文件是否存在（排除 http/https/data 开头）。
    3. 检查 `alt` 部分是否为空。
- **失败后果**: 
    1. 路径无效：Pandoc 警告但仍生成，Word 中图片显示占位符。
    2. alt 为空：交叉引用无法识别图名，自动编号失效。

#### **R22: Lua 过滤器文件存在性**
- **等级**: 🛑 CRITICAL
- **规则**: 构建所需的 Lua 过滤器文件必须存在。
- **验证逻辑**: 检查以下文件是否存在：
    1. `filters/heading_preprocess_filter.lua` - 标题预处理过滤器
    2. `filters/szcu_thesis_filter_v2.lua` - SZCU 论文样式过滤器
- **失败后果**: Pandoc 转换时报错 `Filter not found`，构建流程中断。

#### **R23: 构建配置文件存在性**
- **等级**: 🛑 CRITICAL
- **规则**: 构建所需的配置文件必须存在。
- **验证逻辑**: 检查以下文件是否存在：
    1. `config/reference.docx` - Word 参考文档模板
    2. `config/crossref_config.yaml` - 交叉引用配置文件
- **失败后果**: 
    1. 缺失 `reference.docx`: Word 输出无样式，格式崩坏
    2. 缺失 `crossref_config.yaml`: 图表编号格式不符合要求

#### **R24: 表格命名规范检测**
- **等级**: 🛑 CRITICAL
- **规则**: 所有表格必须提供表名，且遵循标准格式。
- **验证逻辑**:
    1. **表名前缀检测**: 表格定义行必须以 `Table:` 开头 (注意大小写和冒号后的空格)
    2. **表名非空检测**: `Table:` 后必须有非空的表名
    3. **格式完整性**: 表名行的下一行应该是表格内容 (以 `|` 开头的管道表)
- **标准格式**: `Table: 表名`
- **错误示例**:
    * `table: 数据` (小写`table`,不符合规范)
    * `Table:` (缺少表名)
    * `Table :数据` (冒号后缺少空格)
- **正确示例**: `Table: 实验数据对比`
- **失败后果**: 表格无法自动编号,交叉引用失效

---

### 2.4 结构完整性 (Structural Integrity)

#### **R9: 前置标题无编号标记**
- **等级**: ℹ️ INFO (未标记) / 🛑 CRITICAL (格式错误)
- **规则**: 论文正文前的特定一级标题（摘要、Abstract、目录）建议禁止自动编号，但非强制要求。
- **验证逻辑**: 
    1. 检查全文前 3 个 H1 标题是否包含 `{-}` 或 `{.unnumbered}` 属性
    2. **若未标记**：仅给出INFO级别提示（系统Lua过滤器会自动处理）
    3. **若已标记**：严格检验格式是否正确：
       * ✅ 正确: `# 摘要 {-}` 或 `# 摘要 {.unnumbered}`
       * ❌ 错误: `# 摘要{-}` (缺少空格)
       * ❌ 错误: `# 摘要 { - }` (花括号内有多余空格)
- **说明**: 不写标记也可以，Lua过滤器会自动识别前置标题并添加`{-}`标记；但如果写了，必须严格符合格式规范。

#### **R10: 中文摘要完整性**
- **等级**: ⚠️ WARNING
- **规则**: 必须包含中文摘要章节及关键词，且关键词格式必须规范。
- **验证逻辑**: 
    1. 检查是否存在包含"摘要"字样的二级标题 (`##`)。
    2. 检查该区域后方是否紧跟 `**关键词：**` 行。
    3. **关键词格式检测**（增强）:
       * 检查是否使用**全角分号** `；` 分隔（不允许使用 `,`、`，` 或 `;`）
       * 检查关键词前是否有多余空格
       * 检查关键词数量是否在 3-8 个范围内
       * 检查最后一个关键词后是否误加标点符号
- **标准格式**: `**关键词：**绿色低碳；环境友好；可持续发展`
- **错误示例**:
  * `**关键词：** 绿色低碳；环境友好` (关键词前有空格)
  * `**关键词：**绿色低碳,环境友好` (使用了逗号)
  * `**关键词：**绿色低碳;环境友好` (使用了半角分号)
  * `**关键词：**环境友好。` (最后有句号)

#### **R11: 英文摘要完整性**
- **等级**: ⚠️ WARNING
- **规则**: 必须包含英文摘要章节及 Keywords，且 Keywords 格式必须规范。
- **验证逻辑**: 
    1. 检查是否存在包含 "Abstract" (不区分大小写) 的二级标题。
    2. 检查该区域后方是否紧跟 `**Keywords:**` 行。
    3. **Keywords格式检测**（增强）:
       * 检查是否使用**半角分号** `;` 分隔（不允许使用 `,` 或 `；`）
       * 检查关键词前是否有多余空格
       * 检查最后一个关键词后是否误加标点符号
- **标准格式**: `**Keywords:**sustainable development;environmental protection`
- **错误示例**:
  * `**Keywords:** green energy` (关键词前有空格)
  * `**Keywords:**green,energy` (使用了逗号)
  * `**Keywords:**green；energy` (使用了全角分号)

#### **R12: 正文核心章节存在性**
- **等级**: ⚠️ WARNING
- **规则**: 必须存在足够的一级标题（至少应有：中文题目、英文题目、目录 + 正文章节）。
- **验证逻辑**: 检查一级标题数量，若 ≤3 个则提示可能缺少正文章节。
- **说明**: 由于系统会自动为前置标题添加 `{-}` 标记，此规则不再检查 `{-}` 的存在性，仅检测标题数量。

#### **R13: 文末必要章节**
- **等级**: ⚠️ WARNING
- **规则**: 文档中必须包含"参考文献"章节（必须项）。
- **验证逻辑**: 检查所有 H1 标题中是否包含"参考"或"Reference"关键词。
- **说明**: 简化检测，仅检测参考文献是否存在，不再要求致谢、附录等其他章节。

#### **R14: 参考文献锚点**
- **等级**: ⚠️ WARNING
- **规则**: 必须保留 Pandoc 参考文献生成锚点。
- **验证逻辑**: 全文搜索是否存在 `::: {#refs}` 代码块。

---

### 2.5 规范性提示 (Conventions)

#### **R15: 图表引用占位符检测**
- **等级**: ℹ️ INFO
- **规则**: 检测是否存在未替换的引用占位符。
- **验证逻辑**: 搜索 `TODO`, `XXX`, `FIX` 等常见占位符关键词。

#### **R16: 图表 ID 与自动编号规范**
- **等级**: ℹ️ INFO
- **规则**: 图表的引用必须遵循标准格式。
- **说明**: 
  - **图表定义**: 不需要手动添加ID占位符，`auto_cross_ref.py`会自动生成
  - **图表引用**: 使用 `{{fig:图名}}` 或 `{{tbl:表名}}` 格式 (详见README.md)
- **验证逻辑**:
  1. **图片定义格式**: 检查是否符合 `![图名](路径)` 格式
  2. **表格定义格式**: 检查是否符合 `Table: 表名` 格式 (见R24)
  3. **引用格式**: 检测是否使用了过时的 `@fig:` 格式 (应使用 `{{fig:图名}}`)
- **错误示例**:
  * `![](./media/img.png)` (缺少图名,auto_cross_ref.py无法处理)
  * `@fig:id_xxx` (过时格式,应使用 `{{fig:图名}}`)
- **正确示例**:
  * 定义: `![系统架构图](./media/arch.png)`
  * 引用: `如{{fig:系统架构图}}所示`

#### **R17: 关键词分隔符**
- **等级**: ℹ️ INFO
- **规则**: 
  - **中文关键词**: 必须使用全角分号 `；` 分隔 
  - **英文关键词**: 必须使用半角分号 `;` 分隔
- **验证逻辑**: 
  1. 检测 `**关键词：**` 行:
     * 不允许出现: 逗号`,`/`，`、半角分号`;`
     * 必须使用: 全角分号`；`
  2. 检测 `**Keywords:**` 行:
     * 不允许出现: 逗号`,`、全角分号`；`
     * 必须使用: 半角分号`;`

#### **R18: 标题前后空行**
- **等级**: ℹ️ INFO
- **规则**: 标题前后建议空行，增强可读性。
- **验证逻辑**: 检测标题行的上一行和下一行是否为空行。
- **例外**: 连续标题、文档开头、YAML 头部后的首个标题可豁免。

#### **R19: 标题空行规范**
- **等级**: ℹ️ INFO
- **规则**: 标题与正文之间应空行分隔。
- **验证逻辑**:
    1. 检查标题前一行（排除文件首行）
    2. 检查标题后一行（排除文件末行）
- **例外**: 连续标题之间、YAML 分隔符 `---` 后可豁免。

#### **R20: 标题层级与序号一致性检查**
- **等级**: ℹ️ INFO
- **规则**: 若标题手动添加了序号，序号的层级应与 Markdown 层级一致。
- **验证逻辑**:
    1. 提取标题序号（如 `1.2.3`）。
    2. 计算序号层级（点的数量 + 1）。
    3. 与 Markdown 的 `#` 数量对比。
- **例外**:
    * 无序号标题跳过检查
    * 带 `{-}` 的无编号标题跳过
- **错误示例**:
    * `## 1.2.3 标题` (## 是 2 级，但 1.2.3 是 3 级)
    * `### 1.2.3 标题` (都是 3 级)
- **注意**: 检测前会自动去除标题中的 Markdown 格式符号（`**`, `*`, `~~`），避免误判。

#### **R21: 代码块格式检查**
- **等级**: ⚠️ WARNING (caption) / 🛑 CRITICAL (ID格式错误)
- **规则**: 代码块的属性块格式必须规范（允许不写ID）。
- **验证逻辑**:
    1. **建议包含 caption**：所有非 OpenXML 代码块建议包含 `caption="说明"`（改为WARNING级别）。
    2. **ID 格式规范**（若包含 ID）：
        * **可选**：代码块可以不写ID，`auto_cross_ref.py`会自动生成
        * **若写ID**：必须使用 `#lst:id` 格式（完整ID）
        * `#lst` 和 `:` 之间不能有空格
        * `:` 后面紧跟 ID，不能有空格
        * ID 和 `caption` 之间必须有空格
    3. **允许的标准格式**：
        * 格式 1（仅 caption）: ` ```python {caption="用户登录逻辑"} `
        * 格式 2（ID + caption）: ` ```python {#lst:user_login caption="用户登录逻辑"} `
        * 格式 3（无属性）: ` ```python ` （可以不写，但建议添加caption）
- **错误示例**:
    * ` ```python {#lst : id caption="..."}` （井号和冒号之间有空格）
    * ` ```python {#lst: id caption="..."}` （冒号后有空格）
    * ` ```python {#lst:idcaption="..."}` （ID 和 caption 之间缺少空格）
- **正确示例**:
    * ` ```python {caption="数据库连接"} `
    * ` ```python {#lst:db_connect caption="数据库连接"} `
    * ` ```python ` (允许，但建议添加caption)
- **失败后果**: 缺少caption将无法生成编号；ID格式错误会导致引用失效。

---


---

### 2.6 Markdown 输入格式规范 (Markdown Formatting Conventions)

本节规则确保 Markdown 源文件符合标准书写规范（详见 README.md），防止常见输入错误导致转换失败。

#### **R25: 段落缩进检测**
- **等级**:  WARNING
- **规则**: 正文段落不应使用空格或 Tab 进行首行缩进。
- **验证逻辑**:
    1. 检测非代码块、非引用块的行是否以 4 个或更多空格/Tab 开头
    2. 排除列表项、代码块、引用块等合法缩进
    3. 若检测到疑似手动缩进，报警
- **错误示例**: ``    这是一个段落（前面有4个空格）``
- **正确示例**: 
  ````markdown
  这是第一段。
  
  这是第二段。
  ````
- **失败后果**: 缩进段落会被 Pandoc 识别为代码块，导致格式错误。
- **说明**: Markdown 中段落间空行即表示换行，不需要手动缩进。

#### **R27: 图片路径规范检测**
- **等级**:  WARNING
- **规则**: 图片路径必须指向 ``./media/`` 或 ``media/`` 目录（统一管理）。
- **验证逻辑**:
    1. 提取所有图片路径 ``![alt](path)``
    2. 检查路径是否以 ``./media/`` 或 ``media/`` 开头（排除 http/https/data: 链接）
    3. 若路径指向其他目录，报警
- **错误示例**:
    * ``![图片](./images/pic.png)`` - 错误目录
    * ``![图片](../other/pic.png)`` - 不在 media 文件夹
- **正确示例**:
    * ``![图片](./media/pic.png)``
    * ``![图片](media/pic.png)``
- **失败后果**: 路径混乱，图片管理困难，可能导致路径失效。

#### **R29: 表格类型检测**
- **等级**:  WARNING
- **规则**: 只允许使用管道表（pipe table）格式，不支持其他表格类型。
- **验证逻辑**:
    1. 检测表格定义（有 ``Table:`` 前缀的行）
    2. 检查下方是否为管道表格式（以 ``|`` 开头）
    3. 若检测到其他表格类型（如 grid table），报警
- **错误示例**: 使用 grid table（``+---+`` 格式）
- **正确示例**: 
  ````markdown
  Table: 数据表
  
  | 列1 | 列2 |
  | :-- | :-- |
  | 1   | 2   |
  ````
- **失败后果**: 非管道表可能无法正确解析或编号。

#### **R32: YAML 头部多余空行检测**
- **等级**:  WARNING
- **规则**: YAML 配置块（``---`` 包裹的部分）上下不应有多余空行。
- **验证逻辑**:
    1. 检查文件第一行是否是 ``---``（已在 R1 检查）
    2. 检查 YAML 结束 ``---`` 前后是否有多余空行
    3. YAML 块内部不应有空行
- **错误示例**:
  ````markdown
  ---
  
  bibliography: references.bib   YAML 开头有空行
  ---
  ````
- **正确示例**:
  ````markdown
  ---
  bibliography: references.bib
  csl: ./config/gb7714.csl
  ---
  
  # 论文题目
  ````
- **失败后果**: 影响YAML解析，可能导致配置失效。

#### **R36: 必要标题关键词检测**
- **等级**:  WARNING
- **规则**: 检测必要的章节标题是否存在且顺序正确。
- **验证逻辑**:
    1. 检测第一个 H1 是否为中文论文题目
    2. 检测前几个 H2 是否包含 "摘要"、"ABSTRACT"
    3. 检测是否有包含 "目录" 的 H1
    4. 检测是否有 "参考文献" H1（已在 R13）
    5. 检查顺序是否符合规范
- **标准顺序**:
  ````
  # 中文论文题目
  ## 摘要
  # English Title
  ## ABSTRACT
  # 目录
  # 正文章节...
  # 参考文献
  ````
- **失败后果**: 论文结构不完整，影响最终排版效果。

#### **R26: 引用块格式检测**
- **等级**: ℹ INFO
- **规则**: 图表下方的引用块建议使用标准格式 ``>注：`` 或 ``>数据来源：``。
- **验证逻辑**:
    1. 检测图片/表格后紧跟的引用块（``>`` 开头）
    2. 检查是否符合标准前缀格式
    3. 若使用了非标准格式，给出建议
- **标准格式**:
    * ``>注：说明文字``
    * ``>数据来源：说明文字``
- **错误示例**: ``> 这是图表的说明`` （缺少标准前缀）

#### **R28: 交叉引用格式检测**
- **等级**: ℹ INFO
- **规则**: 交叉引用应使用标准格式，前缀和名称之间不应有空格。
- **验证逻辑**:
    1. 检测 ``{{fig:xxx}}``, ``{{tbl:xxx}}``, ``{{lst:xxx}}`` 格式
    2. 检查 ``:`` 和名称之间是否有空格
    3. 检查是否使用了全角花括号 ``｛｛``（提示优化）
- **错误示例**: ``{{fig: 系统架构图}}`` (冒号后有空格)
- **正确示例**: ``{{fig:系统架构图}}``

#### **R30: 文献引用格式检测**
- **等级**: ℹ INFO
- **规则**: 检测是否误用手动编号代替文献引用。
- **验证逻辑**:
    1. 检测文本中的 ``[1]``, ``[2]`` 等纯数字中括号
    2. 排除合法的脚注引用 ``[^1]``
    3. 提示应该使用 ``[@key]`` 格式
- **错误示例**: ``根据研究[1]表明``
- **正确示例**: ``根据研究[@li2024survey]表明``

#### **R31: 半角/全角符号混用检测**
- **等级**: ℹ INFO
- **规则**: 检测 Markdown 语法符号是否误用全角字符。
- **验证逻辑**:
    1. 检测全角括号 ``（）`` 用于 Markdown 链接/图片
    2. 检测全角中括号 ``【】`` 用于 Markdown 链接/图片
    3. 检测全角冒号 ``：`` 用于 ``Table：``
- **错误示例**: ``![图片]（./media/pic.png）``

#### **R37: 列表格式检测**
- **等级**: ℹ INFO
- **规则**: 检测列表项格式是否规范（有序列表、无序列表）。
- **验证逻辑**:
    1. 检测有序列表是否使用 ``1. `` 格式（数字+点+空格）
    2. 检测无序列表是否使用 ``-`` 或 ``*`` 符号
- **错误示例**: ``1.第一项`` (缺少空格)

#### **R33: 行尾空格检测**
- **等级**: ℹ INFO
- **规则**: 检测行尾是否有多余的空格。
- **验证逻辑**: 扫描所有行，检测行尾是否有空格或 Tab。
- **说明**: Markdown 中行尾双空格表示换行，但在论文写作中通常不需要。

#### **R35: 标题大小写一致性检测**
- **等级**: ℹ INFO
- **规则**: 检测英文标题是否符合标题大小写规范。
- **验证逻辑**: 检查 "ABSTRACT" 是否全大写，"Keywords" 是否首字母大写。

#### **R38: 强调符号配对检测**
- **等级**: ℹ INFO
- **规则**: 检测加粗、斜体等强调符号是否正确配对。
- **验证逻辑**: 检测 ``**``, ``*``, ``~~`` 是否成对出现。
- **错误示例**: ``**加粗但没闭合``

## 4. 版本历史 (Version History)

### v1.5 (2025-12-28)
- **新增规则**: 
  - R25: 段落缩进检测
  - R27: 图片路径规范检测
  - R29: 表格类型检测（仅管道表）
  - R32: YAML头部空行检测
  - R36: 必要标题关键词检测
- **说明**: 新增Markdown输入格式规范检查（2.6章节），防止常见输入错误
### v1.4 (2025-12-28)
- **新增规则**: 
  - R22: Lua 过滤器文件存在性检查
  - R23: 构建配置文件存在性检查  
  - R24: 表格命名规范检测
- **更新规则**:
  - R2: 路径从 `template/` 更新为 `config/`
  - R9: 放宽 `{-}` 标记要求，但严格检查已标记格式
  - R10-R11: 增强中英文关键词格式检测（分号、数量、标点）
  - R12: 简化为只检查标题数量
  - R13: 简化为只检测参考文献
  - R21: 放宽代码块ID要求，caption改为建议项

### v1.3 (2025-12-26)
- 完善代码块格式检查，修复属性解析问题

### v1.2 (2025-12-25)
- 新增资源路径检查和标题编号一致性检查

### v1.1 (2025-12-24)
- 完善结构完整性检查

### v1.0 (2025-12-23)
- 初始版本
